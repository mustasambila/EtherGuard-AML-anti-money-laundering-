<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watchlist | EtherGuard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-modern.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-white border-end sidebar" id="sidebar-wrapper">
        <div class="sidebar-heading text-center py-4 primary-text fs-4 fw-bold border-bottom">
            <img src="{{ url_for('static', filename='logo.png') }}" 
     alt="EtherGuard" 
     width="40" 
     class="d-inline-block align-top me-2"> EtherGuard
        </div>
<div class="list-group list-group-flush my-3">
    <a href="{{ url_for('home') }}" class="list-group-item list-group-item-action bg-transparent fw-bold">
        <i class="bi bi-house-door me-2"></i>Home
    </a>
    <a href="{{ url_for('dashboard') }}" class="list-group-item list-group-item-action bg-transparent fw-bold"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
    <a href="{{ url_for('track_wallet') }}" class="list-group-item list-group-item-action bg-transparent fw-bold"><i class="bi bi-search me-2"></i>Track Wallet</a>
    <a href="{{ url_for('watchlist_page') }}" class="list-group-item list-group-item-action bg-transparent fw-bold"><i class="bi bi-eye me-2"></i>Watchlist</a>
    {% if session.is_admin %}
    <a href="{{ url_for('admin_kyc') }}" class="list-group-item list-group-item-action bg-transparent fw-bold"><i class="bi bi-person-badge me-2"></i>Admin KYC</a>
    <a href="{{ url_for('admin_logs') }}" class="list-group-item list-group-item-action bg-transparent fw-bold"><i class="bi bi-file-earmark-text me-2"></i>Admin logs</a>
    {% endif %}
    <a href="{{ url_for('account') }}" class="list-group-item list-group-item-action bg-transparent fw-bold active"><i class="bi bi-person me-2"></i>User Information</a>
</div>
    <div class="sidebar-footer text-center mt-auto mb-3">
        <div class="small text-muted">AML Tip</div>
        <div class="small">Keep your watchlist updated for best results.</div>
    </div>
</div>
<!-- /#sidebar-wrapper -->

<!-- Page Content -->
<div id="page-content-wrapper" class="w-100">
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container-fluid">
            <button class="btn btn-primary" id="menu-toggle">â˜°</button>
            <span class="navbar-brand ms-3">Watchlist</span>
            <div class="ms-auto">
                <span class="me-3">Welcome, {{ session['user'] }}</span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Add to Watchlist Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add Address to Watchlist</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('watchlist_page') }}">
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" name="address" 
                                           placeholder="Enter Ethereum address (0x...)" required>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-plus me-1"></i>Add to Watchlist
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if watchlist_items %}
        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Balance Distribution</h6>
                        <button id="refreshCharts" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="balanceDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Total Value Trend</h6>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="watchlistTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Watchlist Display -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-eye me-2"></i>{% if session.is_admin %}All Users' Watchlists{% else %}Your Watchlist{% endif %}</h6>
                        <form method="POST" action="{{ url_for('export_watchlist_pdf') }}" class="d-inline">
                            <button type="submit" class="btn btn-light btn-sm">
                                <i class="bi bi-file-earmark-pdf me-1"></i>Download Watchlist Report (PDF)
                            </button>
                        </form>
                    </div>
                    <div class="card-body">
                        {% if watchlist_items %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        {% if session.is_admin %}
                                        <th>User</th>
                                        {% endif %}
                                        <th>Address</th>
                                        <th>Balance (ETH)</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in watchlist_items %}
                                    <tr>
                                        {% if session.is_admin %}
                                        <td><span class="badge bg-info">{{ item.username }}</span></td>
                                        {% endif %}
                                        <td><code>{{ item.address[:25] }}...</code></td>
                                        <td>{{ "%.4f"|format(item.balance) if item.balance else 'N/A' }}</td>
                                        <td>
                                            {% if item.flagged %}
                                            <span class="badge bg-warning">Flagged</span>
                                            {% else %}
                                            <span class="badge bg-success">Normal</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-info" data-bs-toggle="collapse" 
                                                    data-bs-target="#transactions-{{ loop.index }}" 
                                                    aria-expanded="false">
                                                <i class="bi bi-list-ul me-1"></i>View Transactions
                                            </button>
                                            {% if not session.is_admin or item.user_id == session.get('user_id') %}
                                            <form method="POST" action="{{ url_for('remove_from_watchlist') }}" class="d-inline">
                                                <input type="hidden" name="address" value="{{ item.address }}">
                                                <button type="submit" class="btn btn-sm btn-danger" 
                                                        onclick="return confirm('Remove this address from watchlist?')">
                                                    <i class="bi bi-trash me-1"></i>Remove
                                                </button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="p-0">
                                            <div class="collapse" id="transactions-{{ loop.index }}">
                                                <div class="card card-body m-2">
                                                    <h6>Recent Transactions:</h6>
                                                    {% if item.transactions %}
                                                    <div class="table-responsive">
                                                        <table class="table table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Hash</th>
                                                                    <th>From</th>
                                                                    <th>To</th>
                                                                    <th>Value (ETH)</th>
                                                                    <th>Date</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for tx in item.transactions[:5] %}
                                                                <tr>
                                                                    <td><code>{{ tx.hash[:10] }}...</code></td>
                                                                    <td><code>{{ tx.from[:10] }}...</code></td>
                                                                    <td><code>{{ tx.to[:10] }}...</code></td>
                                                                    <td>{{ "%.4f"|format((tx.value|int) / 1000000000000000000) }}</td>
                                                                    <td>{{ tx.timeStamp|timestamp_to_date }}</td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    {% else %}
                                                    <p class="text-muted mb-0">No transactions found for this address.</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-eye-slash display-1 text-muted"></i>
                            <h5 class="mt-3 text-muted">Your watchlist is empty</h5>
                            <p class="text-muted">Add Ethereum addresses above to start monitoring them.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Hidden data for JavaScript -->
<div id="watchlist-data" style="display: none;">
    {% if watchlist_items %}
    <span data-has-items="true"></span>
    {% else %}
    <span data-has-items="false"></span>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Menu toggle functionality
document.getElementById('menu-toggle').addEventListener('click', function() {
    document.getElementById('wrapper').classList.toggle('toggled');
});

// Chart variables
let balanceDistributionChart;
let watchlistTrendChart;

function initializeWatchlistCharts() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded');
        return;
    }

    // Balance Distribution Chart (Doughnut)
    const ctx1 = document.getElementById('balanceDistributionChart');
    if (!ctx1) {
        console.error('Balance distribution chart canvas not found');
        return;
    }
    
    try {
        balanceDistributionChart = new Chart(ctx1.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating balance distribution chart:', error);
    }

    // Watchlist Trend Chart (Line)
    const ctx2 = document.getElementById('watchlistTrendChart');
    if (!ctx2) {
        console.error('Watchlist trend chart canvas not found');
        return;
    }
    
    try {
        watchlistTrendChart = new Chart(ctx2.getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Total Value (ETH)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Total Value (ETH)'
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating watchlist trend chart:', error);
    }

    // Load data after charts are initialized
    setTimeout(loadWatchlistData, 100);
}

function loadWatchlistData() {
    fetch('/api/watchlist-balances')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Error loading watchlist data:', data.error);
                return;
            }

            // Update pie chart
            const addresses = data.balances.map(item => 
                item.address.substring(0, 8) + '...' + item.address.substring(item.address.length - 6)
            );
            const balances = data.balances.map(item => item.balance);

            if (balanceDistributionChart && balanceDistributionChart.data) {
                balanceDistributionChart.data.labels = addresses;
                balanceDistributionChart.data.datasets[0].data = balances;
                balanceDistributionChart.update();
            }

            // Update trend chart with mock historical data
            const trendLabels = [];
            const trendData = [];
            const totalBalance = balances.reduce((sum, balance) => sum + balance, 0);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                trendLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                // Generate some variation around the current total
                const variation = (Math.random() - 0.5) * 0.2 * totalBalance;
                trendData.push(Math.max(0, totalBalance + variation));
            }

            if (watchlistTrendChart && watchlistTrendChart.data) {
                watchlistTrendChart.data.labels = trendLabels;
                watchlistTrendChart.data.datasets[0].data = trendData;
                watchlistTrendChart.update();
            }
        })
        .catch(error => {
            console.error('Error fetching watchlist data:', error);
        });
}

// Refresh charts
const refreshChartsButton = document.getElementById('refreshCharts');
if (refreshChartsButton) {
    refreshChartsButton.addEventListener('click', function() {
        this.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refreshing...';
        this.disabled = true;
        
        loadWatchlistData();
        
        setTimeout(() => {
            this.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
            this.disabled = false;
        }, 2000);
    });
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if watchlist has items using hidden data element
    const watchlistData = document.getElementById('watchlist-data');
    const hasItems = watchlistData && watchlistData.querySelector('[data-has-items="true"]');
    
    if (hasItems) {
        // Add a small delay to ensure all DOM elements are ready
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                initializeWatchlistCharts();
            } else {
                console.error('Chart.js library not loaded');
            }
        }, 200);
    }
});
</script>
</body>
</html>
